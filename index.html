<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Information Warfare Monitor: Advanced</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-dark: #0f0c29;
            --bg-panel: rgba(255, 255, 255, 0.05);
            --accent-blue: #4ecdc4;
            --accent-red: #ff6b6b;
            --text-main: #ffffff;
            --text-dim: #a0a0a0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: var(--text-main);
            margin: 0; padding: 20px;
            min-height: 100vh;
        }

        .container { max-width: 1800px; margin: 0 auto; }

        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; background: var(--bg-panel); border-radius: 15px;
            margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .header h1 { margin: 0; font-size: 1.8rem; background: linear-gradient(45deg, var(--accent-blue), #556270); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Layout Grid */
        .grid-main { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        
        /* Sidebar Controls */
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .panel { background: var(--bg-panel); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
        
        .upload-btn {
            background: dashed 2px rgba(255,255,255,0.2);
            padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s;
            margin-bottom: 10px;
        }
        .upload-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--accent-blue); }
        .status-ok { color: #2ecc71; font-size: 0.8rem; }
        
        label { display: block; color: var(--accent-blue); font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; }
        input, select { 
            width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); 
            color: white; border-radius: 5px; margin-bottom: 15px; 
        }
        select { height: 120px; }

        button.action-btn {
            width: 100%; padding: 12px; background: linear-gradient(45deg, var(--accent-blue), #2980b9);
            border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: bold;
        }
        button.action-btn:hover { filter: brightness(1.1); }

        /* KPI Cards */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: var(--bg-panel); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid var(--accent-blue); }
        .kpi-val { font-size: 1.8rem; font-weight: bold; margin: 5px 0; }
        .kpi-lbl { font-size: 0.85rem; color: var(--text-dim); }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .tab-btn {
            padding: 10px 20px; background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-dim); border-radius: 20px; cursor: pointer; transition: 0.2s;
        }
        .tab-btn.active { background: var(--accent-blue); color: #000; border-color: var(--accent-blue); font-weight: bold; }
        
        /* Charts */
        .chart-container { background: var(--bg-panel); padding: 15px; border-radius: 12px; min-height: 450px; position: relative; }
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: span 2; }
        
        /* Comparison Tools */
        .vs-badge { 
            display: inline-block; background: #fff; color: #000; 
            padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; 
        }
        .group-select-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>üåê Information Warfare Monitor</h1>
            <p style="color: var(--text-dim); font-size: 0.9rem;">Analyze Information Suppression: Volume, Intent, and Effectiveness</p>
        </div>
        <div style="text-align: right;">
            <button class="action-btn" onclick="loadDemoData()" style="width: auto; padding: 8px 20px; font-size: 0.9rem; background: rgba(255,255,255,0.1);">Load Demo Data</button>
        </div>
    </div>

    <div class="grid-main">
        <div class="sidebar">
            <div class="panel">
                <label>üìÇ 1. Upload Google Data</label>
                <div class="upload-btn" onclick="document.getElementById('fileDet').click()">
                    Detailed Requests CSV
                    <div id="statusDet" class="status-ok"></div>
                </div>
                <input type="file" id="fileDet" hidden accept=".csv">

                <div class="upload-btn" onclick="document.getElementById('fileOut').click()">
                    Outcomes CSV
                    <div id="statusOut" class="status-ok"></div>
                </div>
                <input type="file" id="fileOut" hidden accept=".csv">
            </div>

            <div class="panel">
                <label>üìÖ Time Period</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="startYear" value="2015" min="2011" max="2025">
                    <input type="number" id="endYear" value="2025" min="2011" max="2025">
                </div>

                <label>üåç Global Filter</label>
                <select id="globalCountry" multiple></select>
                <small style="color: #666">Hold Ctrl/Cmd to select multiple</small>
                
                <button class="action-btn" onclick="runAnalysis()" style="margin-top: 15px;">üöÄ Run Analysis</button>
            </div>
        </div>

        <div>
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-lbl">Total Requests</div>
                    <div class="kpi-val" id="kpiTotal">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-lbl">Primary Weapon (Product)</div>
                    <div class="kpi-val" id="kpiProduct" style="color: var(--accent-blue)">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-lbl">Top Justification</div>
                    <div class="kpi-val" id="kpiReason" style="color: var(--accent-red)">-</div>
                </div>
                <div class="kpi-card" style="border-left-color: #f1c40f;">
                    <div class="kpi-lbl">Google Resistance Rate</div>
                    <div class="kpi-val" id="kpiResistance">-</div>
                </div>
            </div>

            <div class="tabs">
                <div class="tab-btn active" onclick="switchTab('map')">üó∫Ô∏è Geopolitics Map</div>
                <div class="tab-btn" onclick="switchTab('alliance')">‚öñÔ∏è Alliance Analyzer</div>
                <div class="tab-btn" onclick="switchTab('overreach')">üö´ Overreach & Intent</div>
            </div>

            <div id="tab-map" class="tab-content">
                <div class="chart-container">
                    <div id="worldMap"></div>
                </div>
                <div class="chart-row" style="margin-top: 20px;">
                    <div class="chart-container">
                        <h3 style="margin:0 0 10px 0; font-size:1.1rem; color:var(--accent-blue)">Volume over Time</h3>
                        <div id="timeChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="margin:0 0 10px 0; font-size:1.1rem; color:var(--accent-red)">Top "Suppression" Reasons</h3>
                        <div id="reasonChart"></div>
                    </div>
                </div>
            </div>

            <div id="tab-alliance" class="tab-content" style="display:none;">
                <div class="panel" style="margin-bottom: 20px;">
                    <div class="group-select-container">
                        <div>
                            <label style="color: var(--accent-red)">üî¥ Group A (e.g., Aggressors)</label>
                            <select id="groupA" multiple style="height: 150px; background: rgba(255, 107, 107, 0.1);"></select>
                            <div style="margin-top:5px;">
                                <button onclick="selectPreset('A', ['Russia', 'China', 'Turkey', 'Iran'])" style="padding:4px 8px; font-size:0.8rem; cursor:pointer;">Select: Auth Bloc</button>
                            </div>
                        </div>
                        <div>
                            <label style="color: var(--accent-blue)">üîµ Group B (e.g., Allies)</label>
                            <select id="groupB" multiple style="height: 150px; background: rgba(78, 205, 196, 0.1);"></select>
                            <div style="margin-top:5px;">
                                <button onclick="selectPreset('B', ['United States', 'United Kingdom', 'Germany', 'France', 'Poland'])" style="padding:4px 8px; font-size:0.8rem; cursor:pointer;">Select: NATO/EU</button>
                            </div>
                        </div>
                    </div>
                    <button class="action-btn" onclick="runComparison()">‚öîÔ∏è Compare Alliances</button>
                </div>
                
                <div class="chart-row">
                    <div class="chart-container">
                        <h3 style="margin:0 0 10px 0;">Total Request Volume</h3>
                        <div id="compareVol"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="margin:0 0 10px 0;">Use of "National Security"</h3>
                        <div id="compareSec"></div>
                    </div>
                </div>
            </div>

            <div id="tab-overreach" class="tab-content" style="display:none;">
                <div class="chart-container">
                    <h3 style="margin:0 0 10px 0;">The Overreach Matrix</h3>
                    <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">
                        <strong>X-Axis:</strong> Total Volume | <strong>Y-Axis:</strong> Rejection Rate (% No Action Taken)
                        <br>Bubbles in the <em>Top-Right</em> are high-volume spammers with low legal validity.
                    </p>
                    <div id="scatterOverreach"></div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- State ---
    let detailedData = [];
    let outcomeData = [];
    let countriesList = [];

    // --- Demo Data Generator (If user has no files) ---
    function loadDemoData() {
        detailedData = [];
        outcomeData = [];
        const regimes = ['Russia', 'China', 'Turkey', 'Iran'];
        const democracies = ['United States', 'Germany', 'United Kingdom', 'France', 'Poland'];
        const all = [...regimes, ...democracies];

        for(let y=2015; y<=2025; y++) {
            all.forEach(c => {
                // Generate Detailed
                let vol = Math.floor(Math.random() * 200);
                let isAuth = regimes.includes(c);
                if(isAuth) vol *= 5; // Auth creates more noise

                detailedData.push({
                    'Period Ending': `${y}-12-31`, 'Country/Region': c, 'Product': 'YouTube', 
                    'Reason': isAuth ? 'National Security' : 'Defamation', 'Total': vol
                });

                // Generate Outcome
                let rejectRate = isAuth ? 60 + Math.random()*20 : 10 + Math.random()*10; // Auth gets rejected more
                outcomeData.push({
                    'Period Ending': `${y}-12-31`, 'Country/Region': c, 
                    'Number of Requests': vol, '% No Action Taken': rejectRate
                });
            });
        }
        processDataForUI();
        runAnalysis();
    }

    // --- Upload Handlers ---
    document.getElementById('fileDet').addEventListener('change', (e) => loadFile(e, 1));
    document.getElementById('fileOut').addEventListener('change', (e) => loadFile(e, 2));

    function loadFile(e, type) {
        const file = e.target.files[0];
        if(!file) return;
        Papa.parse(file, {
            header: true, dynamicTyping: true, skipEmptyLines: true,
            complete: (res) => {
                if(type === 1) {
                    detailedData = res.data.filter(d => d['Country/Region']);
                    document.getElementById('statusDet').innerText = `‚úÖ ${detailedData.length} rows`;
                } else {
                    outcomeData = res.data.filter(d => d['Country/Region']);
                    document.getElementById('statusOut').innerText = `‚úÖ ${outcomeData.length} rows`;
                }
                processDataForUI();
            }
        });
    }

    function processDataForUI() {
        // Extract unique countries
        const set = new Set([...detailedData.map(d=>d['Country/Region']), ...outcomeData.map(d=>d['Country/Region'])]);
        countriesList = Array.from(set).sort();
        
        // Populate Selects
        populateSelect('globalCountry', countriesList);
        populateSelect('groupA', countriesList);
        populateSelect('groupB', countriesList);
    }

    function populateSelect(id, list) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        list.forEach(c => {
            let opt = document.createElement('option');
            opt.value = c; opt.innerText = c;
            el.appendChild(opt);
        });
    }

    function selectPreset(group, presetCountries) {
        const select = document.getElementById(`group${group}`);
        Array.from(select.options).forEach(opt => {
            opt.selected = presetCountries.includes(opt.value);
        });
    }

    // --- Analysis Engine ---
    function runAnalysis() {
        // 1. Filter Data
        const sY = parseInt(document.getElementById('startYear').value);
        const eY = parseInt(document.getElementById('endYear').value);
        const selC = Array.from(document.getElementById('globalCountry').selectedOptions).map(o=>o.value);
        
        const filterFn = d => {
            let y = new Date(d['Period Ending']).getFullYear();
            let cMatch = selC.length === 0 || selC.includes(d['Country/Region']);
            return y >= sY && y <= eY && cMatch;
        };

        const fDet = detailedData.filter(filterFn);
        const fOut = outcomeData.filter(filterFn);

        updateKPIs(fDet, fOut);
        renderMap(fDet);
        renderOverviewCharts(fDet);
        renderOverreach(fOut);
        
        // If Alliance tab is active, run that too
        if(!document.getElementById('tab-alliance').style.display === 'none') runComparison();
    }

    function updateKPIs(det, out) {
        let total = det.reduce((a,b)=>a+b.Total,0);
        document.getElementById('kpiTotal').innerText = total.toLocaleString();

        // Top Product
        let prodMap = {};
        det.forEach(d => prodMap[d.Product] = (prodMap[d.Product]||0)+d.Total);
        let topP = Object.entries(prodMap).sort((a,b)=>b[1]-a[1])[0];
        document.getElementById('kpiProduct').innerText = topP ? topP[0] : '-';

        // Top Reason
        let reasMap = {};
        det.forEach(d => reasMap[d.Reason] = (reasMap[d.Reason]||0)+d.Total);
        let topR = Object.entries(reasMap).sort((a,b)=>b[1]-a[1])[0];
        document.getElementById('kpiReason').innerText = topR ? topR[0] : '-';

        // Resistance Rate
        if(out.length) {
            let weightedSum = 0, volSum = 0;
            out.forEach(d => {
                let v = d['Number of Requests'] || 0;
                weightedSum += v * (d['% No Action Taken']||0);
                volSum += v;
            });
            let rate = volSum ? (weightedSum/volSum).toFixed(1) : 0;
            document.getElementById('kpiResistance').innerText = rate + '%';
        }
    }

    function renderMap(data) {
        // Aggregate by Country
        let mapData = {};
        data.forEach(d => mapData[d['Country/Region']] = (mapData[d['Country/Region']]||0)+d.Total);
        
        Plotly.newPlot('worldMap', [{
            type: 'choropleth',
            locationmode: 'country names',
            locations: Object.keys(mapData),
            z: Object.values(mapData),
            colorscale: 'Reds',
            marker: { line: {color: '#333', width: 0.5} }
        }], {
            geo: {
                bgcolor: 'rgba(0,0,0,0)',
                showlakes: false,
                projection: {type: 'natural earth'},
                countrycolor: '#444'
            },
            paper_bgcolor: 'rgba(0,0,0,0)',
            font: {color: '#fff'},
            margin: {l:0, r:0, t:0, b:0}
        });
    }

    function renderOverviewCharts(data) {
        // Timeline
        let timeData = {};
        data.forEach(d => {
            let y = new Date(d['Period Ending']).getFullYear();
            timeData[y] = (timeData[y]||0)+d.Total;
        });
        
        Plotly.newPlot('timeChart', [{
            x: Object.keys(timeData), y: Object.values(timeData),
            type: 'scatter', fill: 'tozeroy', line: {color: '#4ecdc4'}
        }], {
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: {color: '#fff'}, margin: {t:10, l:40, r:20, b:30}
        });

        // Top Reasons
        let reasData = {};
        data.forEach(d => reasData[d.Reason] = (reasData[d.Reason]||0)+d.Total);
        let sorted = Object.entries(reasData).sort((a,b)=>b[1]-a[1]).slice(0,8);
        
        Plotly.newPlot('reasonChart', [{
            x: sorted.map(s=>s[1]), y: sorted.map(s=>s[0]),
            type: 'bar', orientation: 'h', marker: {color: '#ff6b6b'}
        }], {
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: {color: '#fff'}, margin: {t:10, l:150, r:20, b:30}
        });
    }

    function runComparison() {
        const groupA = Array.from(document.getElementById('groupA').selectedOptions).map(o=>o.value);
        const groupB = Array.from(document.getElementById('groupB').selectedOptions).map(o=>o.value);
        const sY = parseInt(document.getElementById('startYear').value);
        const eY = parseInt(document.getElementById('endYear').value);

        // Filter Function
        const getVol = (countries, reasonFilter=null) => {
            return detailedData
                .filter(d => countries.includes(d['Country/Region']))
                .filter(d => {
                    let y = new Date(d['Period Ending']).getFullYear();
                    return y >= sY && y <= eY;
                })
                .filter(d => reasonFilter ? d.Reason === reasonFilter : true)
                .reduce((a,b) => a+b.Total, 0);
        };

        let volA = getVol(groupA);
        let volB = getVol(groupB);
        
        let secA = getVol(groupA, 'National Security');
        let secB = getVol(groupB, 'National Security');

        // Render Comparison Charts
        const layout = { paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: {color: '#fff'} };
        
        Plotly.newPlot('compareVol', [{
            x: ['Group A', 'Group B'], y: [volA, volB],
            type: 'bar', marker: {color: ['#ff6b6b', '#4ecdc4']}
        }], {...layout, title: 'Total Volume'});

        Plotly.newPlot('compareSec', [{
            x: ['Group A', 'Group B'], y: [secA, secB],
            type: 'bar', marker: {color: ['#ff6b6b', '#4ecdc4']}
        }], {...layout, title: 'National Security Justification'});
    }

    function renderOverreach(data) {
        // Aggregate by Country
        let agg = {};
        data.forEach(d => {
            let c = d['Country/Region'];
            if(!agg[c]) agg[c] = {req: 0, rejW: 0};
            let n = d['Number of Requests'] || 0;
            agg[c].req += n;
            agg[c].rejW += n * (d['% No Action Taken']||0);
        });

        let x=[], y=[], txt=[], sz=[];
        Object.keys(agg).forEach(c => {
            if(agg[c].req > 50) { // Filter out tiny noise
                x.push(agg[c].req);
                y.push(agg[c].rejW / agg[c].req);
                txt.push(c);
                sz.push(Math.min(50, Math.log(agg[c].req)*5));
            }
        });

        Plotly.newPlot('scatterOverreach', [{
            x: x, y: y, text: txt, mode: 'markers+text',
            marker: {size: sz, color: y, colorscale: 'Viridis', showscale: true}
        }], {
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: {color: '#fff'},
            xaxis: {type: 'log', title: 'Volume (Log Scale)', gridcolor:'#444'},
            yaxis: {title: '% Rejected', gridcolor:'#444'}
        });
    }

    function switchTab(name) {
        document.querySelectorAll('.tab-content').forEach(el=>el.style.display='none');
        document.querySelectorAll('.tab-btn').forEach(el=>el.classList.remove('active'));
        document.getElementById(`tab-${name}`).style.display='block';
        event.target.classList.add('active');
        window.dispatchEvent(new Event('resize'));
    }

    // Init with demo option visible
    // populateSelect done on load
</script>
</body>
</html>
