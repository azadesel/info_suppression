<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Transparency: Information Suppression Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #0f0c29;
            --bg-panel: rgba(255, 255, 255, 0.05);
            --accent-blue: #4ecdc4;
            --accent-red: #ff6b6b;
            --text-main: #ffffff;
            --text-dim: #a0a0a0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: var(--text-main);
            margin: 0; padding: 0;
            min-height: 100vh;
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

        /* Header & Status */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px;
            margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .header h1 { margin: 0; font-size: 1.8rem; background: linear-gradient(45deg, var(--accent-blue), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .status-badge {
            background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 20px;
            font-size: 0.9rem; display: flex; align-items: center; gap: 8px;
        }
        .status-badge.success { color: #2ecc71; border: 1px solid #2ecc71; }
        .status-badge.error { color: #ff6b6b; border: 1px solid #ff6b6b; }

        /* Grid Layout */
        .dashboard-grid { display: grid; grid-template-columns: 280px 1fr; gap: 25px; }

        /* Sidebar */
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .panel { background: var(--bg-panel); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
        
        label { display: block; color: var(--accent-blue); font-size: 0.85rem; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        select, input { 
            width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); 
            color: white; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem;
        }
        select { height: 200px; } /* Tall country list */
        
        button {
            width: 100%; padding: 12px; background: linear-gradient(90deg, var(--accent-blue), #2980b9);
            border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: bold;
            transition: 0.2s;
        }
        button:hover { filter: brightness(1.1); }

        /* KPI Cards */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .kpi-card { 
            background: var(--bg-panel); padding: 20px; border-radius: 12px; 
            text-align: center; border-bottom: 3px solid var(--accent-blue);
        }
        .kpi-val { font-size: 2rem; font-weight: bold; margin: 5px 0; }
        .kpi-label { font-size: 0.85rem; color: var(--text-dim); text-transform: uppercase; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .tab {
            padding: 10px 25px; cursor: pointer; color: var(--text-dim); border-radius: 20px;
            border: 1px solid transparent; transition: 0.3s;
        }
        .tab:hover { background: rgba(255,255,255,0.05); }
        .tab.active { background: var(--accent-blue); color: #000; font-weight: bold; }

        /* Charts */
        .chart-box { background: var(--bg-panel); padding: 15px; border-radius: 12px; min-height: 400px; margin-bottom: 20px; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .chart-title { margin: 0 0 15px 0; font-size: 1.1rem; font-weight: 400; color: #ddd; }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>Information Warfare Monitor</h1>
            <p style="color: var(--text-dim); margin-top: 5px;">Analyzing Government Removal Requests (Volume vs. Outcome)</p>
        </div>
        <div id="fileStatus" class="status-badge">
            <span id="spinner">‚è≥</span> <span id="statusText">Locating CSV Files...</span>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="sidebar">
            <div class="panel">
                <label>üìÖ Time Range</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="startYear" value="2016" min="2011" max="2025">
                    <input type="number" id="endYear" value="2025" min="2011" max="2025">
                </div>

                <label>üåç Select Countries</label>
                <select id="countryFilter" multiple></select>
                <small style="color: #666; display:block; margin-top:-10px; margin-bottom:15px;">Hold Ctrl/Cmd to select multiple</small>

                <button onclick="runAnalysis()">üîÑ Update Dashboard</button>
            </div>

            <div class="panel">
                <label>‚ÑπÔ∏è About This Data</label>
                <p style="font-size: 0.85rem; color: #aaa; line-height: 1.5;">
                    <strong>Detailed Data:</strong> Tracks specific reasons (e.g., "National Security") and products targeted.<br><br>
                    <strong>Outcome Data:</strong> Tracks "Overreach"‚Äîrequests where Google took <em>no action</em> because the content did not violate laws.
                </p>
            </div>
        </div>

        <div>
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-label">Total Requests</div>
                    <div class="kpi-val" id="kpi-total">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Primary Justification</div>
                    <div class="kpi-val" id="kpi-reason" style="color: var(--accent-red)">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Rejection Rate</div>
                    <div class="kpi-val" id="kpi-reject" style="color: #f1c40f">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Top Target</div>
                    <div class="kpi-val" id="kpi-product" style="color: var(--accent-blue)">-</div>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('overview', this)">üìä Global Overview</div>
                <div class="tab" onclick="switchTab('overreach', this)">üö´ Overreach Analysis</div>
                <div class="tab" onclick="switchTab('map', this)">üó∫Ô∏è Geographic Map</div>
            </div>

            <div id="tab-overview" class="view-section">
                <div class="chart-box">
                    <h3 class="chart-title">Timeline of Removal Requests</h3>
                    <div id="timelineChart"></div>
                </div>
                <div class="chart-grid">
                    <div class="chart-box">
                        <h3 class="chart-title">Top 10 Reasons for Censorship</h3>
                        <div id="reasonChart"></div>
                    </div>
                    <div class="chart-box">
                        <h3 class="chart-title">Platforms Targeted</h3>
                        <div id="productChart"></div>
                    </div>
                </div>
            </div>

            <div id="tab-overreach" class="view-section" style="display:none;">
                <div class="chart-box">
                    <h3 class="chart-title">The "Overreach" Matrix (Volume vs. Rejection Rate)</h3>
                    <p style="color:#aaa; font-size:0.9rem; margin-bottom:10px;">
                        Top-Right Quadrant = <strong>High Volume + High Rejection</strong> (Attempted suppression that failed).
                    </p>
                    <div id="scatterChart"></div>
                </div>
                <div class="chart-grid">
                    <div class="chart-box">
                        <h3 class="chart-title">Who is Requesting? (Police vs. Courts)</h3>
                        <div id="requestorChart"></div>
                    </div>
                    <div class="chart-box">
                        <h3 class="chart-title">Outcome Distribution</h3>
                        <div id="outcomeChart"></div>
                    </div>
                </div>
            </div>

            <div id="tab-map" class="view-section" style="display:none;">
                <div class="chart-box" style="height: 600px;">
                    <h3 class="chart-title">Global Intensity Map</h3>
                    <div id="mapChart" style="height: 550px;"></div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- Configuration: Filenames ---
    const FILE_DETAILED = 'google-government-detailed-removal-requests.csv';
    const FILE_OUTCOME = 'google-government-removal-requests.csv';

    // --- State ---
    let detailedData = [];
    let outcomeData = [];
    let allCountries = [];

    // --- Initialization ---
    window.addEventListener('DOMContentLoaded', init);

    function init() {
        const statusEl = document.getElementById('statusText');
        const badge = document.getElementById('fileStatus');
        
        // Helper to load CSV
        const loadCSV = (file) => {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
                    complete: (res) => resolve(res.data),
                    error: (err) => reject(err)
                });
            });
        };

        Promise.all([loadCSV(FILE_DETAILED), loadCSV(FILE_OUTCOME)])
            .then(([det, out]) => {
                // Filter out empty rows
                detailedData = det.filter(d => d['Country/Region'] && d.Total);
                outcomeData = out.filter(d => d['Country/Region']);
                
                // Update UI
                document.getElementById('spinner').innerText = '‚úÖ';
                statusEl.innerText = `Data Loaded (${detailedData.length + outcomeData.length} records)`;
                badge.classList.add('success');

                populateFilters();
                runAnalysis();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('spinner').innerText = '‚ùå';
                statusEl.innerText = 'Error: CSV files not found.';
                badge.classList.add('error');
                alert(`Error: Could not load data.\nEnsure "${FILE_DETAILED}" and "${FILE_OUTCOME}" are in the same folder as this HTML file.`);
            });
    }

    function populateFilters() {
        // Get unique countries from both datasets
        const set = new Set([
            ...detailedData.map(d => d['Country/Region']),
            ...outcomeData.map(d => d['Country/Region'])
        ]);
        allCountries = Array.from(set).sort();

        // Populate Select
        const select = document.getElementById('countryFilter');
        allCountries.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c; opt.innerText = c;
            select.appendChild(opt);
        });

        // Set Defaults (Major Players)
        const defaults = ['Russia', 'China', 'United States', 'Germany', 'Turkey', 'United Kingdom', 'Brazil', 'India'];
        Array.from(select.options).forEach(opt => {
            if (defaults.includes(opt.value)) opt.selected = true;
        });
    }

    // --- Analysis Engine ---
    function runAnalysis() {
        if(detailedData.length === 0) return;

        // 1. Get Filter Values
        const sY = parseInt(document.getElementById('startYear').value);
        const eY = parseInt(document.getElementById('endYear').value);
        const selC = Array.from(document.getElementById('countryFilter').selectedOptions).map(o => o.value);

        // 2. Filter Functions
        const filterFn = (d) => {
            const y = new Date(d['Period Ending']).getFullYear();
            const cMatch = selC.length === 0 || selC.includes(d['Country/Region']);
            return y >= sY && y <= eY && cMatch;
        };

        const fDetailed = detailedData.filter(filterFn);
        const fOutcome = outcomeData.filter(filterFn);

        // 3. Update Dashboard
        updateKPIs(fDetailed, fOutcome);
        renderCharts(fDetailed, fOutcome);
    }

    function updateKPIs(det, out) {
        // Total Volume
        const total = det.reduce((sum, d) => sum + d.Total, 0);
        document.getElementById('kpi-total').innerText = total.toLocaleString();

        // Top Reason
        const reasons = {};
        det.forEach(d => reasons[d.Reason] = (reasons[d.Reason] || 0) + d.Total);
        const topReason = Object.entries(reasons).sort((a,b) => b[1]-a[1])[0];
        document.getElementById('kpi-reason').innerText = topReason ? topReason[0] : '-';

        // Top Product
        const prods = {};
        det.forEach(d => prods[d.Product] = (prods[d.Product] || 0) + d.Total);
        const topProd = Object.entries(prods).sort((a,b) => b[1]-a[1])[0];
        document.getElementById('kpi-product').innerText = topProd ? topProd[0] : '-';

        // Rejection Rate (Weighted Avg)
        let wSum = 0, vSum = 0;
        out.forEach(d => {
            const n = d['Number of Requests'] || 0;
            const r = d['% No Action Taken'] || 0;
            wSum += n * r;
            vSum += n;
        });
        const rate = vSum > 0 ? (wSum / vSum).toFixed(1) + '%' : '-';
        document.getElementById('kpi-reject').innerText = rate;
    }

    function renderCharts(det, out) {
        const layoutConfig = {
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#fff' }, margin: { t: 30, l: 40, r: 20, b: 40 }
        };

        // --- 1. Overview Tab ---
        
        // Timeline
        const years = {};
        det.forEach(d => {
            const y = new Date(d['Period Ending']).getFullYear();
            years[y] = (years[y] || 0) + d.Total;
        });
        Plotly.newPlot('timelineChart', [{
            x: Object.keys(years), y: Object.values(years),
            type: 'scatter', fill: 'tozeroy', line: { color: '#4ecdc4', width: 3 }
        }], layoutConfig);

        // Reasons Bar
        const rData = {};
        det.forEach(d => rData[d.Reason] = (rData[d.Reason] || 0) + d.Total);
        const rSorted = Object.entries(rData).sort((a,b) => b[1]-a[1]).slice(0, 10);
        Plotly.newPlot('reasonChart', [{
            x: rSorted.map(x => x[1]), y: rSorted.map(x => x[0]),
            type: 'bar', orientation: 'h', marker: { color: '#ff6b6b' }
        }], { ...layoutConfig, margin: { l: 150 } });

        // Product Pie
        const pData = {};
        det.forEach(d => pData[d.Product] = (pData[d.Product] || 0) + d.Total);
        const pSorted = Object.entries(pData).sort((a,b) => b[1]-a[1]).slice(0, 8);
        Plotly.newPlot('productChart', [{
            values: pSorted.map(x => x[1]), labels: pSorted.map(x => x[0]),
            type: 'pie', hole: 0.4, marker: { colors: ['#4ecdc4', '#2ecc71', '#3498db', '#9b59b6'] }
        }], layoutConfig);

        // --- 2. Overreach Tab ---

        // Scatter (Volume vs Rejection)
        const scatterData = {};
        out.forEach(d => {
            const c = d['Country/Region'];
            if(!scatterData[c]) scatterData[c] = { req: 0, rejW: 0 };
            const n = d['Number of Requests'] || 0;
            scatterData[c].req += n;
            scatterData[c].rejW += n * (d['% No Action Taken'] || 0);
        });

        const xVal = [], yVal = [], txtVal = [], szVal = [], colVal = [];
        Object.keys(scatterData).forEach(c => {
            const tot = scatterData[c].req;
            if (tot > 50) { // Filter noise
                const rate = scatterData[c].rejW / tot;
                xVal.push(tot);
                yVal.push(rate);
                txtVal.push(c);
                szVal.push(Math.min(50, Math.log(tot) * 6));
                colVal.push(rate); // Color by rejection rate
            }
        });

        Plotly.newPlot('scatterChart', [{
            x: xVal, y: yVal, text: txtVal, mode: 'markers+text',
            marker: { size: szVal, color: colVal, colorscale: 'Portland', showscale: true }
        }], {
            ...layoutConfig,
            xaxis: { type: 'log', title: 'Total Volume (Log Scale)', gridcolor: '#444' },
            yaxis: { title: '% Rejected (No Action)', gridcolor: '#444' }
        });

        // Requestor Pie
        const reqData = {};
        out.forEach(d => reqData[d.Requestor] = (reqData[d.Requestor] || 0) + (d['Number of Requests'] || 0));
        Plotly.newPlot('requestorChart', [{
            values: Object.values(reqData), labels: Object.keys(reqData),
            type: 'pie', hole: 0.4
        }], layoutConfig);

        // Outcomes Pie
        let outcomes = { 'Removed (Legal)': 0, 'Removed (Policy)': 0, 'No Action': 0 };
        out.forEach(d => {
            const n = d['Number of Requests'] || 0;
            outcomes['Removed (Legal)'] += n * (d['% Removed-Legal'] || 0);
            outcomes['Removed (Policy)'] += n * (d['% Removed-Policy'] || 0);
            outcomes['No Action'] += n * (d['% No Action Taken'] || 0);
        });
        Plotly.newPlot('outcomeChart', [{
            values: Object.values(outcomes), labels: Object.keys(outcomes),
            type: 'pie', marker: { colors: ['#2ecc71', '#3498db', '#e74c3c'] }
        }], layoutConfig);

        // --- 3. Map Tab ---
        const mapVals = {};
        det.forEach(d => mapVals[d['Country/Region']] = (mapVals[d['Country/Region']] || 0) + d.Total);
        Plotly.newPlot('mapChart', [{
            type: 'choropleth', locationmode: 'country names',
            locations: Object.keys(mapVals), z: Object.values(mapVals),
            colorscale: 'Reds', marker: { line: { color: '#333', width: 0.5 } }
        }], {
            ...layoutConfig,
            geo: { bgcolor: 'rgba(0,0,0,0)', showlakes: false, projection: { type: 'natural earth' }, countrycolor: '#444' }
        });
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).style.display = 'block';
        btn.classList.add('active');
        
        // Force Plotly resize
        window.dispatchEvent(new Event('resize'));
    }
</script>

</body>
</html>
