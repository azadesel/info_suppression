<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Information Suppression Monitor</title>
    <link rel="icon" type="image/png" href="logo.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        /* --- THEMING VARIABLES --- */
        :root {
            --bg-body: #f4f7f6;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-dim: #7f8c8d;
            --border-color: #e0e0e0;
            --accent-blue: #3498db;
            --accent-red: #e74c3c;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        [data-theme="dark"] {
            --bg-body: #0f0c29;
            --bg-card: rgba(255, 255, 255, 0.05);
            --text-main: #ffffff;
            --text-dim: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-blue: #4ecdc4;
            --accent-red: #ff6b6b;
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 30px; }

        /* HEADER */
        .header {
            background: var(--bg-card);
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid var(--border-color);
        }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo-img { height: 50px; width: auto; }
        .logo-img[src=""] { display: none; }
        .header h1 { margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--text-main); }
        .header p { margin: 5px 0 0 0; color: var(--text-dim); font-size: 0.95rem; }

        /* THEME TOGGLE */
        .theme-toggle {
            background: var(--bg-body); border: 1px solid var(--border-color);
            color: var(--text-main); padding: 8px 15px; border-radius: 20px;
            cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .theme-toggle:hover { filter: brightness(0.9); }

        .status-pill {
            background: var(--bg-body); padding: 6px 12px; border-radius: 20px;
            font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 8px;
            color: var(--text-dim); border: 1px solid var(--border-color);
        }
        .status-pill.ready { color: #2ecc71; border-color: #2ecc71; }
        .status-pill.error { color: #e74c3c; border-color: #e74c3c; }

        /* GRID */
        .dashboard-grid { display: grid; grid-template-columns: 280px 1fr; gap: 25px; }
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .control-panel {
            background: var(--bg-card); padding: 20px; border-radius: 12px;
            box-shadow: var(--shadow); border: 1px solid var(--border-color);
        }

        /* INPUTS */
        label { display: block; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-dim); margin-bottom: 8px; }
        select, input {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem; 
            background: var(--bg-body); color: var(--text-main);
        }
        select:focus, input:focus { border-color: var(--accent-blue); outline: none; }
        select { height: 250px; }
        button.refresh-btn {
            width: 100%; padding: 12px; background: var(--accent-blue); color: white;
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer;
        }
        button.refresh-btn:hover { filter: brightness(1.1); }

        /* KPI Cards */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .kpi-card {
            background: var(--bg-card); padding: 20px; border-radius: 12px;
            box-shadow: var(--shadow); border-left: 4px solid var(--accent-blue);
            border: 1px solid var(--border-color); border-left-width: 4px;
        }
        .kpi-val { font-size: 2rem; font-weight: 800; color: var(--text-main); margin: 5px 0; }
        .kpi-lbl { font-size: 0.8rem; text-transform: uppercase; color: var(--text-dim); font-weight: 600; }

        /* TABS */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); }
        .tab {
            padding: 12px 25px; cursor: pointer; font-weight: 600; color: var(--text-dim);
            border-radius: 6px 6px 0 0; background: transparent; transition: 0.2s;
            margin-bottom: -2px; border-bottom: 2px solid transparent;
        }
        .tab:hover { color: var(--accent-blue); background: var(--bg-card); }
        .tab.active { color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); background: var(--bg-card); }

        /* CHARTS */
        .chart-box {
            background: var(--bg-card); padding: 25px; border-radius: 12px;
            box-shadow: var(--shadow); margin-bottom: 25px; border: 1px solid var(--border-color);
            min-height: 450px;
        }
        .chart-header { margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .chart-title { margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        .chart-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-left">
            <img src="logo.png" onerror="this.src='https://img.icons8.com/color/96/shield.png'" alt="Logo" class="logo-img">
            <div>
                <h1>Information Suppression Monitor</h1>
                <p>Top 10 Analysis & Overreach Detection</p>
            </div>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div id="fileStatus" class="status-pill"><span>‚è≥ Initializing...</span></div>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="themeIcon">üåô</span> <span id="themeText">Dark Mode</span>
            </button>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="sidebar">
            <div class="control-panel">
                <label>üìÖ Time Range</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="startYear" value="2011" min="2011" max="2025">
                    <input type="number" id="endYear" value="2025" min="2011" max="2025">
                </div>
                <label>üåç Filter Countries</label>
                <select id="countryFilter" multiple></select>
                <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: -10px; margin-bottom: 15px;">
                    Select specific countries to filter the Top 10 lists, or leave blank to see Global Top 10.
                </div>
                <button class="refresh-btn" onclick="runAnalysis()">Update Dashboard</button>
            </div>
        </div>

        <div>
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-lbl">Total Volume</div>
                    <div class="kpi-val" id="kpi-total">-</div>
                </div>
                <div class="kpi-card" style="border-left-color: var(--accent-red);">
                    <div class="kpi-lbl">#1 Censorship Reason</div>
                    <div class="kpi-val" id="kpi-reason" style="color: var(--accent-red);">-</div>
                </div>
                <div class="kpi-card" style="border-left-color: #f1c40f;">
                    <div class="kpi-lbl">Avg. Rejection Rate</div>
                    <div class="kpi-val" id="kpi-reject">-</div>
                </div>
                <div class="kpi-card" style="border-left-color: #9b59b6;">
                    <div class="kpi-lbl">#1 Targeted Platform</div>
                    <div class="kpi-val" id="kpi-product" style="color: #8e44ad;">-</div>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('top10', this)">üèÜ Global Top 10s</div>
                <div class="tab" onclick="switchTab('reasons', this)">‚öñÔ∏è Reasons Deep Dive</div>
                <div class="tab" onclick="switchTab('intent', this)">üö´ Intent & Overreach</div>
            </div>

            <div id="tab-top10" class="view-section">
                <div class="chart-box">
                    <div class="chart-header">
                        <h3 class="chart-title">Timeline: Top 10 Most Active Censors</h3>
                        <p style="color: var(--text-dim); font-size: 0.9rem; margin-top: 5px;">
                            Shows the removal volume over time for the top 10 countries (by total volume) in the selected period.
                        </p>
                    </div>
                    <div id="timelineChart"></div>
                </div>

                <div class="chart-grid-2">
                    <div class="chart-box">
                        <div class="chart-header"><h3 class="chart-title">Top 10 Reasons for Removal</h3></div>
                        <div id="topReasonChart"></div>
                    </div>
                    <div class="chart-box">
                        <div class="chart-header"><h3 class="chart-title">Top 10 Targeted Platforms</h3></div>
                        <div id="topProductChart"></div>
                    </div>
                </div>
            </div>

            <div id="tab-reasons" class="view-section" style="display:none;">
                <div class="chart-box">
                    <div class="chart-header">
                        <h3 class="chart-title">Evolution of Censorship Justifications</h3>
                        <p style="color: var(--text-dim); font-size: 0.9rem; margin-top: 5px;">
                            How the top 5 reasons have trended over time. Are governments shifting from "Defamation" to "National Security"?
                        </p>
                    </div>
                    <div id="reasonsTimelineChart"></div>
                </div>
                <div class="chart-box">
                    <div class="chart-header">
                        <h3 class="chart-title">Reasons by Platform</h3>
                        <p style="color: var(--text-dim); font-size: 0.9rem; margin-top: 5px;">
                            Which justifications are used for which products? (e.g. Is YouTube mostly censored for "National Security" or "Copyright"?)
                        </p>
                    </div>
                    <div id="reasonsPlatformChart"></div>
                </div>
            </div>

            <div id="tab-intent" class="view-section" style="display:none;">
                <div class="chart-box">
                    <div class="chart-header">
                        <h3 class="chart-title">Overreach Quadrant (Volume vs. Rejection)</h3>
                        <p style="color: var(--text-dim); font-size: 0.9rem; margin-top: 5px;">
                            <strong>Color Legend:</strong> <span style="color:#e74c3c">Red</span> = High Rejection (Overreach), <span style="color:#2ecc71">Green</span> = High Compliance (Valid).
                            Bubbles in the top-right represent high-volume requests that Google largely ignored.
                        </p>
                    </div>
                    <div id="scatterOverreach"></div>
                </div>
                <div class="chart-box">
                    <div class="chart-header"><h3 class="chart-title">Normalized Justification Share (100% Stacked)</h3></div>
                    <div id="normalizedStackChart"></div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const FILE_DETAILED = 'google-government-detailed-removal-requests.csv';
    const FILE_OUTCOME = 'google-government-removal-requests.csv';

    let detailedData = [];
    let outcomeData = [];
    let currentFilteredDet = [];
    let currentFilteredOut = [];
    let currentTab = 'top10';
    let isDark = false;

    // --- Theming ---
    function toggleTheme() {
        isDark = !isDark;
        document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
        document.getElementById('themeIcon').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        document.getElementById('themeText').innerText = isDark ? 'Light Mode' : 'Dark Mode';
        if(currentFilteredDet.length > 0) renderActiveTab();
    }

    // --- Init ---
    window.addEventListener('DOMContentLoaded', () => {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) toggleTheme();

        Promise.all([loadCSV(FILE_DETAILED), loadCSV(FILE_OUTCOME)])
            .then(([det, out]) => {
                detailedData = det.filter(d => d['Country/Region'] && d.Total);
                outcomeData = out.filter(d => d['Country/Region']);
                
                document.getElementById('fileStatus').className = 'status-pill ready';
                document.getElementById('fileStatus').innerHTML = `<span>‚úÖ Data Loaded</span>`;
                
                initFilters();
                runAnalysis();
            }).catch(err => {
                console.error(err);
                document.getElementById('fileStatus').className = 'status-pill error';
                document.getElementById('fileStatus').innerHTML = `<span>‚ùå CSV Files Missing</span>`;
            });
    });

    function loadCSV(file) {
        return new Promise((resolve, reject) => {
            Papa.parse(file, {
                download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
                complete: res => resolve(res.data),
                error: err => reject(err)
            });
        });
    }

    function initFilters() {
        const set = new Set([...detailedData.map(d=>d['Country/Region']), ...outcomeData.map(d=>d['Country/Region'])]);
        const list = Array.from(set).sort();
        const sel = document.getElementById('countryFilter');
        list.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c; opt.innerText = c;
            sel.appendChild(opt);
        });
    }

    function runAnalysis() {
        if(!detailedData.length) return;
        
        const sY = parseInt(document.getElementById('startYear').value);
        const eY = parseInt(document.getElementById('endYear').value);
        const countries = Array.from(document.getElementById('countryFilter').selectedOptions).map(o => o.value);
        
        const filterFn = d => {
            const y = new Date(d['Period Ending']).getFullYear();
            const cMatch = countries.length === 0 || countries.includes(d['Country/Region']);
            return y >= sY && y <= eY && cMatch;
        };

        currentFilteredDet = detailedData.filter(filterFn);
        currentFilteredOut = outcomeData.filter(filterFn);

        updateKPIs(currentFilteredDet, currentFilteredOut);
        renderActiveTab();
    }

    function updateKPIs(det, out) {
        const total = det.reduce((a,b)=>a+b.Total,0);
        document.getElementById('kpi-total').innerText = total.toLocaleString();

        const getTop = (d,k) => {
            const m={}; d.forEach(r=>m[r[k]]=(m[r[k]]||0)+r.Total);
            const s = Object.entries(m).sort((a,b)=>b[1]-a[1]);
            return s.length ? s[0][0] : '-';
        };
        document.getElementById('kpi-reason').innerText = getTop(det, 'Reason');
        document.getElementById('kpi-product').innerText = getTop(det, 'Product');

        let wS=0, vS=0;
        out.forEach(d => {
            const n = d['Number of Requests']||0;
            wS += n*(d['% No Action Taken']||0);
            vS += n;
        });
        document.getElementById('kpi-reject').innerText = vS ? (wS/vS).toFixed(1)+'%' : '-';
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+tabId).style.display = 'block';
        btn.classList.add('active');
        currentTab = tabId;
        renderActiveTab();
    }

    function renderActiveTab() {
        const det = currentFilteredDet;
        const out = currentFilteredOut;
        if(det.length === 0) return;

        if(currentTab === 'top10') {
            renderTop10Timeline(det);
            renderTop10Bar(det, 'Reason', 'topReasonChart', '#e74c3c');
            renderTop10Bar(det, 'Product', 'topProductChart', '#8e44ad');
        } else if(currentTab === 'reasons') {
            renderReasonsTimeline(det);
            renderReasonsPlatformBar(det);
        } else if(currentTab === 'intent') {
            renderScatter(out);
            renderStack(det);
        }
    }

    function getLayout() {
        const textColor = isDark ? '#ffffff' : '#2c3e50';
        const gridColor = isDark ? '#444' : '#eee';
        return {
            paper_bgcolor: 'rgba(0,0,0,0)', 
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Helvetica Neue', color: textColor },
            margin: { t:30, l:50, r:20, b:40 },
            xaxis: { gridcolor: gridColor, zerolinecolor: gridColor },
            yaxis: { gridcolor: gridColor, zerolinecolor: gridColor },
            colorway: isDark 
                ? ['#4ecdc4', '#ff6b6b', '#f1c40f', '#9b59b6', '#3498db'] 
                : ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6']
        };
    }

    // --- Renderers ---

    function renderTop10Timeline(data) {
        const totals = {};
        data.forEach(d => totals[d['Country/Region']] = (totals[d['Country/Region']] || 0) + d.Total);
        const top10List = Object.keys(totals).sort((a,b) => totals[b] - totals[a]).slice(0, 10);

        const t = {};
        data.forEach(d => {
            const c = d['Country/Region'];
            if(top10List.includes(c)) {
                const y = new Date(d['Period Ending']).getFullYear();
                if(!t[c]) t[c]={}; 
                t[c][y] = (t[c][y]||0)+d.Total;
            }
        });

        const tr = Object.keys(t).map(c => ({
            x: Object.keys(t[c]), y: Object.values(t[c]), name: c, type: 'scatter', mode: 'lines+markers',
            hovertemplate: '%{y:,.0f} requests<extra>%{fullData.name}</extra>'
        }));

        Plotly.newPlot('timelineChart', tr, { ...getLayout(), showlegend: true });
    }

    function renderTop10Bar(data, key, divId, color) {
        const counts = {};
        data.forEach(d => counts[d[key]] = (counts[d[key]] || 0) + d.Total);
        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 10);
        
        Plotly.newPlot(divId, [{
            x: sorted.map(v => v[1]),
            y: sorted.map(v => v[0]),
            type: 'bar', orientation: 'h',
            marker: { color: color },
            hovertemplate: '%{x:,.0f} requests<extra></extra>'
        }], { ...getLayout(), margin: { l: 150 } });
    }

    function renderReasonsTimeline(data) {
        // Find Top 5 Reasons overall
        const rTotals = {};
        data.forEach(d => rTotals[d.Reason] = (rTotals[d.Reason] || 0) + d.Total);
        const top5 = Object.keys(rTotals).sort((a,b) => rTotals[b] - rTotals[a]).slice(0, 5);

        const t = {};
        data.forEach(d => {
            if(top5.includes(d.Reason)) {
                const y = new Date(d['Period Ending']).getFullYear();
                if(!t[d.Reason]) t[d.Reason]={};
                t[d.Reason][y] = (t[d.Reason][y]||0) + d.Total;
            }
        });

        const tr = Object.keys(t).map(r => ({
            x: Object.keys(t[r]), y: Object.values(t[r]), name: r, type: 'scatter', mode: 'lines+markers'
        }));

        Plotly.newPlot('reasonsTimelineChart', tr, { ...getLayout(), showlegend: true });
    }

    function renderReasonsPlatformBar(data) {
        // Group by Reason -> Product
        const matrix = {};
        data.forEach(d => {
            if(!matrix[d.Reason]) matrix[d.Reason] = {};
            matrix[d.Reason][d.Product] = (matrix[d.Reason][d.Product] || 0) + d.Total;
        });

        // Get Top 8 Reasons
        const rTotals = {};
        data.forEach(d => rTotals[d.Reason] = (rTotals[d.Reason] || 0) + d.Total);
        const topReasons = Object.keys(rTotals).sort((a,b) => rTotals[b] - rTotals[a]).slice(0, 8);

        // Get Top 5 Products
        const pTotals = {};
        data.forEach(d => pTotals[d.Product] = (pTotals[d.Product] || 0) + d.Total);
        const topProducts = Object.keys(pTotals).sort((a,b) => pTotals[b] - pTotals[a]).slice(0, 5);

        // Create Traces (Stack by Product)
        const traces = topProducts.map(prod => ({
            name: prod,
            type: 'bar',
            x: topReasons,
            y: topReasons.map(r => matrix[r] ? (matrix[r][prod] || 0) : 0)
        }));

        Plotly.newPlot('reasonsPlatformChart', traces, { ...getLayout(), barmode: 'stack', xaxis: {tickangle: -25} });
    }

    function renderScatter(data) {
        const a={}; 
        data.forEach(d=>{
            const c=d['Country/Region']; if(!a[c]) a[c]={req:0, rej:0};
            const n=d['Number of Requests']||0; a[c].req+=n; a[c].rej+=n*(d['% No Action Taken']||0);
        });
        const x=[], y=[], t=[], sz=[], cl=[];
        Object.keys(a).forEach(c=>{
            if(a[c].req>50) {
                const rate=a[c].rej/a[c].req;
                x.push(a[c].req); y.push(rate); t.push(c);
                sz.push(Math.min(40, Math.log(a[c].req)*5));
                cl.push(rate);
            }
        });
        
        Plotly.newPlot('scatterOverreach', [{
            x, y, text:t, mode:'markers+text', 
            marker:{
                size:sz, color:cl, opacity:0.8, 
                // Green (0) -> Yellow -> Red (100)
                colorscale: [[0, '#2ecc71'], [0.5, '#f1c40f'], [1, '#e74c3c']],
                cmin: 0, cmax: 100, 
                colorbar: { title: 'Rejection %' }, showscale: true
            },
            hovertemplate: '<b>%{text}</b><br>Volume: %{x:,}<br>Rejected: %{y:.1f}%<extra></extra>'
        }], {
            ...getLayout(), 
            xaxis:{type:'log', title:'Volume (Log)', gridcolor: isDark?'#444':'#eee'}, 
            yaxis:{title:'Rejection Rate %', gridcolor: isDark?'#444':'#eee'}
        });
    }

    function renderStack(data) {
        const cr={}; data.forEach(d=>{
            if(!cr[d['Country/Region']]) cr[d['Country/Region']]={};
            cr[d['Country/Region']][d.Reason]=(cr[d['Country/Region']][d.Reason]||0)+d.Total;
        });
        const gr={}; data.forEach(d=>gr[d.Reason]=(gr[d.Reason]||0)+d.Total);
        const top5 = Object.entries(gr).sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>x[0]);
        const tr = top5.map(r => ({
            name: r, type: 'bar', x: Object.keys(cr),
            y: Object.keys(cr).map(c => {
                const tot = Object.values(cr[c]).reduce((a,b)=>a+b,0);
                return tot ? ((cr[c][r]||0)/tot)*100 : 0;
            }),
            hovertemplate: '%{y:.1f}%<extra>%{fullData.name}</extra>'
        }));
        Plotly.newPlot('normalizedStackChart', tr, {...getLayout(), barmode:'stack', yaxis:{title:'% Share'}});
    }
</script>
</body>
</html>
